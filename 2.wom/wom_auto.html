<!-- WOM í˜ì´ì§€ ìë™í™” í”„ë¡ íŠ¸ì—”ë“œ (ê°œì„ ë²„ì „) -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WOM Event</title>
  <style>
    .wom-container {
      max-width: 600px;
      margin: 2rem auto;
      text-align: center;
      font-family: 'Apple SD Gothic Neo', sans-serif;
      position: relative;
    }
    .wom-container img {
      width: 100%;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 0.5rem;
      opacity: 0;
      transition: opacity 0.7s ease;
    }
    .wom-container img.visible {
      opacity: 1;
    }
    .wom-container p {
      margin-top: 0.5rem;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .loading-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 9998;
      display: none;
    }
    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #1F3EF5;
      border-radius: 50%;
      width: 60px; height: 60px;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      display: none;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg);}
      100% { transform: translate(-50%, -50%) rotate(360deg);}
    }
    .fallback-text {
      color: #999;
      font-size: 18px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="wom-container">
    <div class="loading-overlay"></div>
    <div class="loader"></div>
    <p id="wom-caption"></p>
    <img id="wom-poster" alt="WOM Poster" style="display:none;" />
    <img id="wom-workout" alt="WOM Workout" style="display:none;" />
    <div id="fallback-text" class="fallback-text" style="display:none;"></div>
  </div>
  <script>
    // â˜… ë°±ì—”ë“œ Apps Script URL
    const PROXY_URL = 'https://script.google.com/macros/s/AKfycbyL5a4AUuPnxI5qt0gNav_a7LpGsm5oBgGFZHtjojQ-3NH5QBgqLtrxomCxcVVSGiaV/exec';
    const CACHE_KEY = 'wom_manifest_cache';
    const CACHE_TTL = 3600 * 1000; // 1ì‹œê°„(ms)

    const overlay = document.querySelector('.loading-overlay');
    const loader  = document.querySelector('.loader');
    const fallbackEl = document.getElementById('fallback-text');

    function showLoading(show) {
      overlay.style.display = show ? 'block' : 'none';
      loader.style.display = show ? 'block' : 'none';
    }

    // ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ ì‹œ ì•ˆë‚´ë¬¸êµ¬/ëŒ€ì²´ì´ë¯¸ì§€ ë…¸ì¶œ
    function setImageError(imgEl, type = 'poster') {
      imgEl.style.display = 'none';
      fallbackEl.style.display = 'block';
      if(type === 'poster'){
        fallbackEl.textContent = 'í¬ìŠ¤í„° ì´ë¯¸ì§€ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.';
      } else {
        fallbackEl.textContent = 'WOM ìš´ë™ ì´ë¯¸ì§€ê°€ ì•„ì§ ê³µê°œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
      }
    }

    (async () => {
      showLoading(true);

      // 1) ì„œë²„ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (Apps Scriptì—ì„œ now=true ì§€ì›)
      let now;
      try {
        const nowRes = await fetch(`${PROXY_URL}?now=true`);
        const nowJson = await nowRes.json();
        now = new Date(nowJson.now);
      } catch(e){
        now = new Date(); // fallback (ë¸Œë¼ìš°ì € ì‹œê°„)
      }

      // 2) manifest ê°€ì ¸ì˜¤ê¸° (localStorage ìºì‹œ)
      async function fetchManifest() {
        const raw = localStorage.getItem(CACHE_KEY);
        if (raw) {
          const { keys, ts } = JSON.parse(raw);
          if (Date.now() - ts < CACHE_TTL) return keys;
        }
        const keys = await fetch(`${PROXY_URL}?manifest=true`).then(res => res.json());
        localStorage.setItem(CACHE_KEY, JSON.stringify({ keys, ts: Date.now() }));
        return keys;
      }

      const keys = await fetchManifest();

      // 3) ë‚ ì§œ ê³„ì‚°
      let dateKey = null, eventDate = null, revealStart = null, showWorkout = false;
      for (const key of keys) {
        const yy = 2000 + Number(key.slice(0,2));
        const mm = Number(key.slice(2,4)) - 1;
        const dd = Number(key.slice(4,6));
        const ed = new Date(yy, mm, dd, 0,0,0);
        const rs = new Date(ed);
        rs.setDate(ed.getDate() - 3);
        if (now >= rs && now <= ed) {
          dateKey = key; eventDate = ed; revealStart = rs; showWorkout = (now.toDateString() === ed.toDateString());
          break;
        }
        if (!dateKey && now < rs) {
          dateKey = key; eventDate = ed; revealStart = rs;
        }
      }

      // 4) ì´ë¯¸ì§€ ë¡œë“œ (ë³‘ë ¬)
      let posterBody = '', workoutBody = '';
      if(dateKey) {
        // í¬ìŠ¤í„° ì´ë¯¸ì§€ëŠ” 3ì¼ ì „ë¶€í„° ê³µê°œ
        posterBody  = await fetch(`${PROXY_URL}?date=${dateKey}&type=poster`).then(r => r.text());
        // ì›Œí¬ì•„ì›ƒ ì´ë¯¸ì§€ëŠ” ë‹¹ì¼ì—ë§Œ ê³µê°œ
        workoutBody = showWorkout
            ? await fetch(`${PROXY_URL}?date=${dateKey}&type=workout`).then(r => r.text())
            : '';
      }

      // 5) DOM ì—…ë°ì´íŠ¸
      showLoading(false);

      const posterEl = document.getElementById('wom-poster');
      const workoutEl = document.getElementById('wom-workout');
      const captionEl = document.getElementById('wom-caption');
      const weekdays = ['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'];

      fallbackEl.style.display = 'none';

      if (!posterBody) {
        setImageError(posterEl, 'poster');
      } else {
        posterEl.src = posterBody;
        posterEl.style.display = 'block';
        posterEl.onload = () => posterEl.classList.add('visible');
        posterEl.onerror = () => setImageError(posterEl, 'poster');
      }

      if (showWorkout && workoutBody) {
        workoutEl.src = workoutBody;
        workoutEl.style.display = 'block';
        workoutEl.onload = () => workoutEl.classList.add('visible');
        workoutEl.onerror = () => setImageError(workoutEl, 'workout');
        const wd = weekdays[eventDate.getDay()];
        captionEl.textContent = `ğŸš€ ${eventDate.getMonth()+1}ì›” ${eventDate.getDate()}ì¼ (${wd}) WOMì™€ë“œ ê³µê°œ ğŸ”¥`;
      } else if(!showWorkout && now >= revealStart) {
        // ì•„ì§ ì›Œí¬ì•„ì›ƒ ë¯¸ê³µê°œ, í¬ìŠ¤í„°ë§Œ ë…¸ì¶œ
        const wd = weekdays[eventDate.getDay()];
        captionEl.textContent = `ğŸ“£ ${eventDate.getMonth()+1}ì›” ${eventDate.getDate()}ì¼ [${wd}]ì— ìš´ë™ì´ ê³µê°œë©ë‹ˆë‹¤!`;
      } else {
        // ì°¨ê¸° WOM ëŒ€ê¸° ì¤‘
        captionEl.textContent = `â³ ë‹¤ìŒ WOM ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`;
      }
    })();
  </script>
</body>
</html>