<!-- ÌååÏùº: wom_auto.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WOM Event</title>
  <style>
    .wom-container {
      max-width: 600px;
      margin: 2rem auto;
      text-align: center;
      position: relative;
      font-family: 'Apple SD Gothic Neo', sans-serif;
    }
    .wom-container img {
      width: 100%;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      opacity: 0;
      transition: opacity 0.4s ease;
      margin-bottom: 0.5rem;
    }
    .wom-container img[src] {
      opacity: 1;
    }
    .wom-container p {
      margin-top: 0.5rem;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .loading-overlay {
      position: absolute;
      inset: 0;
      background-color: rgba(255, 255, 255, 0.7);
      display: none;
      z-index: 9;
    }
    .loader {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      border: 8px solid #f3f3f3;
      border-top: 8px solid #1F3EF5;
      border-radius: 50%;
      width: 60px; height: 60px;
      animation: spin 1s linear infinite;
      display: none;
      z-index: 10;
    }
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="wom-container">
    <div class="loading-overlay"></div>
    <div class="loader"></div>
    <p id="wom-caption"></p>
    <img id="wom-poster" alt="WOM Poster" />
    <img id="wom-workout" alt="WOM Workout" style="display:none;" />
  </div>

  <script>
  (async () => {
    const overlay   = document.querySelector('.loading-overlay');
    const loader    = document.querySelector('.loader');
    const posterEl  = document.getElementById('wom-poster');
    const workoutEl = document.getElementById('wom-workout');
    const captionEl = document.getElementById('wom-caption');

    const PROXY_URL = 'https://script.google.com/macros/s/AKfycbyS4rAtqCaRJs8hD0L16qYaFiWCAjyMJsfjN1KM5mLAmKKPftacsLhso70ovhDjQ-ot/exec';
    const CACHE_KEY = 'wom_manifest_cache';
    const CACHE_TTL = 3600 * 1000; // 1ÏãúÍ∞Ñ

    // 1) Service Worker Ïä§ÌÅ¨Î¶ΩÌä∏Î•º BlobÏúºÎ°ú ÏÉùÏÑ±¬∑Îì±Î°ù
    const swCode = `
      const CACHE_NAME = 'wom-cache-v1';
      function shouldCache(req) {
        const url = new URL(req.url);
        if (url.searchParams.get('manifest') === 'true') return true;
        if (req.destination === 'image') return true;
        return false;
      }
      self.addEventListener('install', e => {
        self.skipWaiting();
        e.waitUntil(caches.open(CACHE_NAME));
      });
      self.addEventListener('activate', e => {
        e.waitUntil(self.clients.claim());
      });
      self.addEventListener('fetch', e => {
        const req = e.request;
        if (!shouldCache(req)) return;
        e.respondWith(
          caches.open(CACHE_NAME).then(cache =>
            cache.match(req).then(resp =>
              resp ||
              fetch(req).then(netRes => {
                cache.put(req, netRes.clone());
                return netRes;
              })
            )
          )
        );
      });
    `;
    const blob      = new Blob([swCode], { type: 'application/javascript' });
    const swUrl     = URL.createObjectURL(blob);
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker
        .register(swUrl, { scope: './' })
        .then(reg => console.log('SW registered:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    }

    // 2) Ìó¨Ìçº: fetch + ÏÉÅÌÉú ÏΩîÎìú Í≤ÄÏÇ¨
    async function fetchWithStatus(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Status ${res.status}`);
        return await res.text();
      } catch {
        return null;
      }
    }

    // 3) manifest Ï∫êÏãú(fetchManifest)
    async function fetchManifest() {
      const raw = localStorage.getItem(CACHE_KEY);
      if (raw) {
        try {
          const { keys, ts } = JSON.parse(raw);
          if (Date.now() - ts < CACHE_TTL) return keys;
        } catch {}
      }
      const keys = await fetch(`${PROXY_URL}?manifest=true`)
        .then(r => r.json())
        .catch(() => []);
      localStorage.setItem(CACHE_KEY, JSON.stringify({ keys, ts: Date.now() }));
      return keys;
    }

    // 4) Î°úÎî© ÌëúÏãú
    overlay.style.display = loader.style.display = 'block';

    // 5) ÏàúÏ∞® Ïã§Ìñâ: manifest ‚Üí ÎÇ†Ïßú ÌåêÎã® ‚Üí Ïù¥ÎØ∏ÏßÄ Î°úÎìú ‚Üí ÌôîÎ©¥ Í∞±Ïã†
    const now  = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
    const keys = await fetchManifest();

    let dateKey = null, eventDate = null, revealStart = null, showWorkout = false;
    for (const key of keys) {
      const yy = 2000 + Number(key.slice(0,2));
      const mm = Number(key.slice(2,4)) - 1;
      const dd = Number(key.slice(4,6));
      const ed = new Date(Date.UTC(yy, mm, dd, 0, 0, 0));
      ed.setHours(ed.getHours() + 9);
      const rs = new Date(ed);
      rs.setDate(rs.getDate() - 3);

      if (now >= rs && now <= ed) {
        dateKey     = key;
        eventDate   = ed;
        revealStart = rs;
        showWorkout = true;
        break;
      }
      if (!dateKey && now < rs) {
        dateKey     = key;
        eventDate   = ed;
        revealStart = rs;
      }
    }

    // 6) Ïù¥ÎØ∏ÏßÄ Î°úÎìú (Ìè¨Ïä§ÌÑ∞ + Ïö¥Îèô)
    const posterBody  = await fetchWithStatus(`${PROXY_URL}?date=${dateKey}&type=poster`);
    const workoutBody = showWorkout
      ? await fetchWithStatus(`${PROXY_URL}?date=${dateKey}&type=workout`)
      : null;

    // 7) Î°úÎî© Ïà®Í∏∞Í∏∞
    overlay.style.display = loader.style.display = 'none';

    // 8) Í≤∞Í≥º Ï≤òÎ¶¨
    const weekdays = ['ÏùºÏöîÏùº','ÏõîÏöîÏùº','ÌôîÏöîÏùº','ÏàòÏöîÏùº','Î™©ÏöîÏùº','Í∏àÏöîÏùº','ÌÜ†ÏöîÏùº'];

    if (!posterBody) {
      captionEl.textContent = '‚ö†Ô∏è Ìè¨Ïä§ÌÑ∞ Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      return;
    }
    posterEl.src     = posterBody;
    posterEl.loading = 'eager';

    if (showWorkout) {
      if (!workoutBody) {
        captionEl.textContent = '‚ö†Ô∏è Ïö¥Îèô Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
        return;
      }
      workoutEl.src     = workoutBody;
      workoutEl.style.display = 'block';
      captionEl.textContent   = `üöÄ ${eventDate.getMonth()+1}Ïõî ${eventDate.getDate()}Ïùº (${weekdays[eventDate.getDay()]}) WOM Í≥µÍ∞ú üî•`;
    } else {
      captionEl.textContent = `üì£ ${revealStart.getMonth()+1}Ïõî ${revealStart.getDate()}Ïùº (${weekdays[revealStart.getDay()]}) WOM Í≥µÍ∞ú ÏòàÏ†ï`;
    }
  })();
  </script>
</body>
</html>