<!-- WOM 페이지 자동화 프론트엔드 (개선버전) -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WOM Event</title>
  <style>
    .wom-container {
      max-width: 600px;
      margin: 2rem auto;
      text-align: center;
      font-family: 'Apple SD Gothic Neo', sans-serif;
      position: relative;
    }
    .wom-container img {
      width: 100%;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 0.5rem;
      opacity: 0;
      transition: opacity 0.7s ease;
    }
    .wom-container img.visible {
      opacity: 1;
    }
    .wom-container p {
      margin-top: 0.5rem;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .loading-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 9998;
      display: none;
    }
    .loader {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #1F3EF5;
      border-radius: 50%;
      width: 60px; height: 60px;
      animation: spin 1s linear infinite;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      display: none;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg);}
      100% { transform: translate(-50%, -50%) rotate(360deg);}
    }
    .fallback-text {
      color: #999;
      font-size: 18px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="wom-container">
    <div class="loading-overlay"></div>
    <div class="loader"></div>
    <p id="wom-caption"></p>
    <img id="wom-poster" alt="WOM Poster" style="display:none;" />
    <img id="wom-workout" alt="WOM Workout" style="display:none;" />
    <div id="fallback-text" class="fallback-text" style="display:none;"></div>
  </div>
  <script>
    // ★ 백엔드 Apps Script URL
    const PROXY_URL = 'https://script.google.com/macros/s/AKfycbyL5a4AUuPnxI5qt0gNav_a7LpGsm5oBgGFZHtjojQ-3NH5QBgqLtrxomCxcVVSGiaV/exec';
    const CACHE_KEY = 'wom_manifest_cache';
    const CACHE_TTL = 3600 * 1000; // 1시간(ms)

    const overlay = document.querySelector('.loading-overlay');
    const loader  = document.querySelector('.loader');
    const fallbackEl = document.getElementById('fallback-text');

    function showLoading(show) {
      overlay.style.display = show ? 'block' : 'none';
      loader.style.display = show ? 'block' : 'none';
    }

    // 이미지 로딩 실패 시 안내문구/대체이미지 노출
    function setImageError(imgEl, type = 'poster') {
      imgEl.style.display = 'none';
      fallbackEl.style.display = 'block';
      if(type === 'poster'){
        fallbackEl.textContent = '포스터 이미지가 준비 중입니다.';
      } else {
        fallbackEl.textContent = 'WOM 운동 이미지가 아직 공개되지 않았습니다.';
      }
    }

    (async () => {
      showLoading(true);

      // 1) 서버 시간 가져오기 (Apps Script에서 now=true 지원)
      let now;
      try {
        const nowRes = await fetch(`${PROXY_URL}?now=true`);
        const nowJson = await nowRes.json();
        now = new Date(nowJson.now);
      } catch(e){
        now = new Date(); // fallback (브라우저 시간)
      }

      // 2) manifest 가져오기 (localStorage 캐시)
      async function fetchManifest() {
        const raw = localStorage.getItem(CACHE_KEY);
        if (raw) {
          const { keys, ts } = JSON.parse(raw);
          if (Date.now() - ts < CACHE_TTL) return keys;
        }
        const keys = await fetch(`${PROXY_URL}?manifest=true`).then(res => res.json());
        localStorage.setItem(CACHE_KEY, JSON.stringify({ keys, ts: Date.now() }));
        return keys;
      }

      const keys = await fetchManifest();

      // 3) 날짜 계산
      let dateKey = null, eventDate = null, revealStart = null, showWorkout = false;
      for (const key of keys) {
        const yy = 2000 + Number(key.slice(0,2));
        const mm = Number(key.slice(2,4)) - 1;
        const dd = Number(key.slice(4,6));
        const ed = new Date(yy, mm, dd, 0,0,0);
        const rs = new Date(ed);
        rs.setDate(ed.getDate() - 3);
        if (now >= rs && now <= ed) {
          dateKey = key; eventDate = ed; revealStart = rs; showWorkout = (now.toDateString() === ed.toDateString());
          break;
        }
        if (!dateKey && now < rs) {
          dateKey = key; eventDate = ed; revealStart = rs;
        }
      }

      // 4) 이미지 로드 (병렬)
      let posterBody = '', workoutBody = '';
      if(dateKey) {
        // 포스터 이미지는 3일 전부터 공개
        posterBody  = await fetch(`${PROXY_URL}?date=${dateKey}&type=poster`).then(r => r.text());
        // 워크아웃 이미지는 당일에만 공개
        workoutBody = showWorkout
            ? await fetch(`${PROXY_URL}?date=${dateKey}&type=workout`).then(r => r.text())
            : '';
      }

      // 5) DOM 업데이트
      showLoading(false);

      const posterEl = document.getElementById('wom-poster');
      const workoutEl = document.getElementById('wom-workout');
      const captionEl = document.getElementById('wom-caption');
      const weekdays = ['일요일','월요일','화요일','수요일','목요일','금요일','토요일'];

      fallbackEl.style.display = 'none';

      if (!posterBody) {
        setImageError(posterEl, 'poster');
      } else {
        posterEl.src = posterBody;
        posterEl.style.display = 'block';
        posterEl.onload = () => posterEl.classList.add('visible');
        posterEl.onerror = () => setImageError(posterEl, 'poster');
      }

      if (showWorkout && workoutBody) {
        workoutEl.src = workoutBody;
        workoutEl.style.display = 'block';
        workoutEl.onload = () => workoutEl.classList.add('visible');
        workoutEl.onerror = () => setImageError(workoutEl, 'workout');
        const wd = weekdays[eventDate.getDay()];
        captionEl.textContent = `🚀 ${eventDate.getMonth()+1}월 ${eventDate.getDate()}일 (${wd}) WOM와드 공개 🔥`;
      } else if(!showWorkout && now >= revealStart) {
        // 아직 워크아웃 미공개, 포스터만 노출
        const wd = weekdays[eventDate.getDay()];
        captionEl.textContent = `📣 ${eventDate.getMonth()+1}월 ${eventDate.getDate()}일 [${wd}]에 운동이 공개됩니다!`;
      } else {
        // 차기 WOM 대기 중
        captionEl.textContent = `⏳ 다음 WOM 이벤트를 기다려주세요.`;
      }
    })();
  </script>
</body>
</html>