<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>통합 페이지</title>
  
  <style>
    :root {
      --primary-blue: #3182F6;
      --primary-blue-light: #4593FC;
      --violet-purple: #8B5CF6;
      --white: #FFFFFF;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --branch-sangmu: #10B981;
      --branch-sinchang: #3B82F6;
      --branch-ochi: #F59E0B;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Pretendard", sans-serif;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
    }

    .container {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 8px;
      box-sizing: border-box;
    }

    .result-container {
      flex-shrink: 0;
      background: var(--white);
      color: var(--gray-800);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--gray-200);
      font-weight: 600;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }

    /* 메인 카드 그리드 - 반응형 개선 */
    .toggle-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
      justify-content: center;
    }

    .toggle-button {
      flex: 1 1 calc(12.5% - 8px);
      min-width: 120px;
      max-width: 140px;
    }

    /* 줄바꿈 시 균등 배치 */
    @media screen and (max-width: 1200px) {
      .toggle-button {
        flex: 1 1 calc(25% - 8px);
        min-width: 110px;
      }
    }

    @media screen and (max-width: 768px) {
      .toggle-container {
        gap: 6px;
      }
      
      .toggle-button {
        flex: 1 1 calc(50% - 6px);
        min-width: 90px;
        max-width: none;
      }
    }

    /* 카드형 메인 버튼 - 크기 축소 */
    .toggle-button {
      border: none;
      background: var(--white);
      color: var(--gray-700);
      padding: 12px 8px;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      border: 2px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }

    .toggle-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .toggle-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-blue);
    }

    .toggle-button:hover::before {
      transform: scaleX(1);
    }

    .toggle-button.active {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      color: var(--white);
      border-color: var(--primary-blue);
      box-shadow: 0 4px 12px 0 rgba(49, 130, 246, 0.4);
      transform: translateY(-2px);
    }

    .toggle-button.active::before {
      transform: scaleX(1);
      background: var(--white);
      opacity: 0.3;
    }

    /* 특별 버튼들 (이월대상자, 노쇼체크) */
    #button6.active, #button7.active {
      background: linear-gradient(135deg, var(--violet-purple) 0%, #A78BFA 100%);
      box-shadow: 0 4px 12px 0 rgba(139, 92, 246, 0.4);
    }

    /* 버튼 아이콘 - 크기 축소 */
    .button-icon {
      font-size: 20px;
      margin-bottom: 2px;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }

    /* 통합된 서브 버튼 컨테이너 - 크기 축소 */
    .branch-sub-container {
      display: none;
      margin-top: 8px;
      padding: 8px;
      background: var(--gray-100);
      border-radius: 10px;
    }

    .branch-sub-container.show {
      display: block;
    }

    .branch-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .branch-toggle-button {
      border: none;
      background: var(--white);
      color: var(--gray-700);
      padding: 8px 6px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      border: 2px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    .branch-toggle-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-blue);
    }

    .branch-toggle-button.active {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-light) 100%);
      color: var(--white);
      border-color: var(--primary-blue);
      box-shadow: 0 2px 8px 0 rgba(49, 130, 246, 0.3);
      transform: translateY(-1px);
    }

    /* 지점별 색상 */
    .branch-toggle-button.sangmu.active {
      background: linear-gradient(135deg, var(--branch-sangmu) 0%, #34D399 100%);
      box-shadow: 0 2px 8px 0 rgba(16, 185, 129, 0.3);
    }

    .branch-toggle-button.sinchang.active {
      background: linear-gradient(135deg, var(--branch-sinchang) 0%, #60A5FA 100%);
      box-shadow: 0 2px 8px 0 rgba(59, 130, 246, 0.3);
    }

    .branch-toggle-button.ochi.active {
      background: linear-gradient(135deg, var(--branch-ochi) 0%, #FBBF24 100%);
      box-shadow: 0 2px 8px 0 rgba(245, 158, 11, 0.3);
    }

    .branch-toggle-button.staff.active {
      background: linear-gradient(135deg, var(--violet-purple) 0%, #A78BFA 100%);
      box-shadow: 0 2px 8px 0 rgba(139, 92, 246, 0.3);
    }

    /* iframe 컨테이너 - 높이 조정 */
    .dataFrame-container {
      flex: 1;
      position: relative;
      min-height: 400px;
      overflow: hidden;
      transition: opacity .3s ease;
      display: flex;
      flex-direction: column;
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--gray-200);
      margin-bottom: 8px;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      display: block;
      flex-grow: 1;
    }

    .shin-container {
      flex-grow: 1;
      transition: opacity .3s ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    .shin-stack {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 400px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      box-sizing: border-box;
      flex-grow: 1;
      overflow: hidden;
    }

    .shin-stack iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      border: 0;
      border-radius: 12px;
      transform: scale(1.0);
      transform-origin: top left;
      background: var(--white);
    }

    /* 로딩 스타일 */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      z-index: 999;
      display: none;
      border-radius: 16px;
    }

    .loader {
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--primary-blue);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      display: none;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    [hidden] {
      display: none !important;
    }

    /* 모바일 최적화 */
    @media screen and (max-width: 768px) {
      .container {
        padding: 8px;
      }
      
      .result-container {
        padding: 16px;
        margin-bottom: 8px;
        border-radius: 12px;
      }

      .toggle-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .toggle-button {
        padding: 12px 8px;
        font-size: 12px;
        border-radius: 10px;
      }

      .button-icon {
        font-size: 20px;
      }

      .branch-buttons {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }

      .branch-toggle-button {
        padding: 8px 6px;
        font-size: 11px;
      }

      iframe {
        width: 110% !important;
        height: 100% !important;
        transform-origin: top left !important;
        transform: scale(0.91) !important;
        border-radius: 12px !important;
      }

      .shin-stack iframe {
        width: 110% !important;
        height: 100% !important;
        transform: scale(0.91) !important;
        transform-origin: top left !important;
        border-radius: 12px !important;
      }

      .dataFrame-container {
        border-radius: 12px;
        height: 800px;
        min-height: 800px;
      }

      .shin-stack {
        border-radius: 12px;
        min-height: 800px;
      }
    }

    @media screen and (max-height: 600px) {
      .result-container {
        padding: 12px;
      }
      
      .toggle-button {
        padding: 8px 6px;
        font-size: 11px;
      }

      .button-icon {
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="result-container">
      <div class="toggle-container">
        <button class="toggle-button active" id="button1">
          <div class="button-icon">📊</div>
          종합현황 차트
        </button>
        <button class="toggle-button" id="button2">
          <div class="button-icon">📅</div>
          월단위 달성현황
        </button>
        <button class="toggle-button" id="button3">
          <div class="button-icon">💰</div>
          인센내역 및 정책
        </button>
        <button class="toggle-button" id="button4">
          <div class="button-icon">👥</div>
          연간 회원수
        </button>
        <button class="toggle-button" id="button5">
          <div class="button-icon">🏢</div>
          지점 대시보드
        </button>
        <button class="toggle-button" id="button6">
          <div class="button-icon">📋</div>
          이월대상자
        </button>
        <button class="toggle-button" id="button7">
          <div class="button-icon">❌</div>
          노쇼체크
        </button>
        <button class="toggle-button" id="button8">
          <div class="button-icon">📦</div>
          배송상품 확인
        </button>
      </div>

      <!-- 지점 대시보드 서브 버튼들 (통합된 4개 버튼) -->
      <div class="branch-sub-container" id="branchSubContainer">
        <div class="branch-buttons">
          <button class="branch-toggle-button sangmu active" 
            data-url="https://lookerstudio.google.com/embed/reporting/64be6fe1-640e-457b-9108-1c70d60e666e/page/buSUF">
            🌿 상무점 대시보드
          </button>
          <button class="branch-toggle-button sinchang" 
            data-url="https://lookerstudio.google.com/embed/reporting/64be6fe1-640e-457b-9108-1c70d60e666e/page/p_gfze1gk9ud" 
            id="shinBtn">
            💙 신창점 대시보드
          </button>
          <button class="branch-toggle-button ochi" 
            data-url="https://lookerstudio.google.com/embed/reporting/64be6fe1-640e-457b-9108-1c70d60e666e/page/p_suzy22l9ud">
            🧡 오치점 대시보드
          </button>
          <button class="branch-toggle-button staff" 
            data-url="https://lookerstudio.google.com/embed/reporting/64be6fe1-640e-457b-9108-1c70d60e666e/page/p_d1s8t8pavd">
            👨‍💼 전지점 담당자별 등록률
          </button>
        </div>
      </div>
    </div>
    
    <div class="dataFrame-container" id="dataFrameContainer">
      <div class="loading-overlay"></div>
      <div class="loader"></div>
      
      <div id="shinContainer" class="shin-container" hidden>
        <div class="shin-stack">
          <iframe id="shinBranchFrame"
            src="https://lookerstudio.google.com/embed/reporting/64be6fe1-640e-457b-9108-1c70d60e666e/page/p_gfze1gk9ud"
            title="신창점 대시보드" allowfullscreen loading="eager"></iframe>
          <iframe id="shinStaffFrame"
            src="https://lookerstudio.google.com/embed/reporting/695906da-94dd-4027-aa85-300c66ba158e/page/eMJQF"
            title="담당자 대시보드" allowfullscreen loading="eager" hidden></iframe>
        </div>
      </div>
      
      <iframe id="dataFrame"></iframe>
    </div>
  </div>

  <script>
    const dataFrame = document.getElementById('dataFrame');
    const buttons = document.querySelectorAll('.toggle-button');
    const branchButtons = document.querySelectorAll('.branch-toggle-button');
    const branchSubContainer = document.getElementById('branchSubContainer');
    const shinContainer = document.getElementById('shinContainer');
    const shinBranchFrame = document.getElementById('shinBranchFrame');
    const shinStaffFrame = document.getElementById('shinStaffFrame');
    const shinBtn = document.getElementById('shinBtn');
    const dataFrameContainer = document.getElementById('dataFrameContainer');

    let shinIsStaffMode = false;
    let branchSubVisible = false;
    let lastSelectedBranchIndex = 0; // 마지막 선택된 지점 기억

    const dataUrls = {
      button1: "https://soslyk.github.io/imweb/1.incentive/OverviewChart.html",
      button2: "https://soslyk.github.io/imweb/1.incentive/MonthlyProgress.html",
      button3: "https://soslyk.github.io/imweb/1.incentive/RewardPolicy.html",
      button4: "https://soslyk.github.io/imweb/1.incentive/ComparisonBranch.html",
      button6: "https://crossfitpaan.com/carryover",
      button7: "https://soslyk.github.io/imweb/1.incentive/noshow.html",
      button8: "https://crossfitpaan.com/checkdelivery"
    };

    // 개선된 모바일 화면 스크롤 함수
    function scrollToElement(element, offset = 0) {
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          const rect = element.getBoundingClientRect();
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const targetTop = rect.top + scrollTop - offset;
          
          window.scrollTo({
            top: targetTop,
            behavior: 'smooth'
          });
        }, 150); // 애니메이션 완료 후 스크롤
      }
    }

    function updateFrame(url) {
      const loader = document.querySelector('.loader');
      const overlay = document.querySelector('.loading-overlay');

      // If the requested URL is already loaded, do not reload (prevents refresh on toggle of sub buttons)
      if (dataFrame && dataFrame.src === url) {
        // Ensure any visible loader/overlay are hidden
        loader.style.display = 'none';
        overlay.style.display = 'none';
        return;
      }

      loader.style.display = 'block';
      overlay.style.display = 'block';

      dataFrame.onload = function() {
        setTimeout(() => {
          loader.style.display = 'none';
          overlay.style.display = 'none';
        }, 300);
      };

      dataFrame.src = url;
    }

    const activateButton = (btn, isMainButton = false) => {
      if (isMainButton) {
        buttons.forEach(b => b.classList.remove("active"));
      } else {
        branchButtons.forEach(b => b.classList.remove("active"));
      }
      btn.classList.add("active");
    };

    const updateShinLabel = () => {
      shinBtn.innerHTML = shinIsStaffMode ? "👨‍💼 담당자 대시보드" : "💙 신창점 대시보드";
    };

    const showShin = () => {
      shinContainer.hidden = false;
      dataFrame.hidden = true;
      
      shinContainer.style.display = 'flex';
      shinContainer.style.height = '100%';
      shinContainer.style.flexGrow = '1';
      
      const shinStack = shinContainer.querySelector('.shin-stack');
      if (shinStack) {
        shinStack.style.height = '100%';
        shinStack.style.flexGrow = '1';
        shinStack.style.minHeight = '400px';
      }
      
      shinBranchFrame.hidden = shinIsStaffMode;
      shinStaffFrame.hidden = !shinIsStaffMode;
      
      setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
      }, 100);
    };

    const showCommon = (url) => {
      shinContainer.hidden = true;
      shinContainer.style.display = 'none';
      dataFrame.hidden = false;
      dataFrame.style.display = 'block';
      updateFrame(url);
      shinIsStaffMode = false;
      updateShinLabel();
    };

    function setupMainButtons() {
      // 일반 메인 버튼들 (서브 버튼 없음)
      ['button1', 'button2', 'button3', 'button4', 'button6', 'button7', 'button8'].forEach(buttonId => {
        document.getElementById(buttonId).addEventListener('click', () => {
          activateButton(document.getElementById(buttonId), true);
          branchSubContainer.classList.remove('show');
          branchSubVisible = false;
          shinContainer.hidden = true;
          dataFrame.hidden = false;
          updateFrame(dataUrls[buttonId]);
          
          // 모바일에서 데이터 컨테이너로 스크롤
          scrollToElement(dataFrameContainer, 10);
        });
      });

      // 지점 대시보드 버튼 (개선된 토글 기능)
      document.getElementById('button5').addEventListener('click', () => {
        activateButton(document.getElementById('button5'), true);
        
        if (!branchSubVisible) {
          // 서브 버튼 표시
          branchSubContainer.classList.add('show');
          branchSubVisible = true;
          
          // 마지막 선택된 지점 버튼 활성화 (또는 첫 번째)
          branchButtons.forEach((b, index) => {
            b.classList.remove("active");
            if (index === lastSelectedBranchIndex) {
              b.classList.add("active");
            }
          });
          
          // 마지막 선택된 지점의 데이터 로드
          const selectedButton = branchButtons[lastSelectedBranchIndex];
          if (selectedButton === shinBtn) {
            showShin();
          } else {
            shinContainer.hidden = true;
            dataFrame.hidden = false;
            updateFrame(selectedButton.dataset.url);
          }
          
          // 모바일에서 서브 버튼으로 스크롤
          scrollToElement(branchSubContainer, 10);
        } else {
          // 서브 버튼 숨기기 (데이터는 그대로 유지)
          branchSubContainer.classList.remove('show');
          branchSubVisible = false;
          
          // 모바일에서 데이터 컨테이너로 스크롤
          scrollToElement(dataFrameContainer, 10);
        }
        
        updateShinLabel();
      });
    }

    function setupBranchButtons() {
      branchButtons.forEach((btn, index) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          // 선택된 지점 인덱스 저장
          lastSelectedBranchIndex = index;

          if (btn === shinBtn) {
            if (!shinBtn.classList.contains("active")) {
              activateButton(shinBtn);
              shinIsStaffMode = false;
              updateShinLabel();
              showShin();
              return;
            }
            
            shinIsStaffMode = !shinIsStaffMode;
            updateShinLabel();
            showShin();
            return;
          }

          activateButton(btn);
          showCommon(btn.dataset.url);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      setupMainButtons();
      setupBranchButtons();
      
      updateFrame(dataUrls.button1);
      
      shinIsStaffMode = false;
      updateShinLabel();
      
      console.log('Step 1 최종 완료: 카드 크기 축소 + 개선된 토글 + 자동 스크롤 수정');
    });
  </script>
</body>
</html>